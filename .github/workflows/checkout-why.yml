name: Gemini Data Analysis

on:
  workflow_dispatch:
    inputs:
      prompt_file:
        description: "Path to the prompt file (relative to repo root)"
        required: true
        default: ".github/prompts/prompt.txt"
      output_file:
        description: "Path to save Gemini output"
        required: true
        default: "gemini_output.txt"

jobs:
  analyze:
    runs-on: ubuntu-latest
    env:
      GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}  # å¿…å¡«ï¼Œä½¿ç”¨ Gemini API Key
    steps:
      # 1ï¸âƒ£ Checkout ä»“åº“
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2ï¸âƒ£ è¯»å– prompt æ–‡ä»¶ï¼Œè¿è¡Œ Gemini CLI
      - name: Run Gemini CLI analysis
        id: gemini
        run: |
          # è¯»å–æ–‡ä»¶å†…å®¹
          PROMPT=$(cat "${{ github.event.inputs.prompt_file }}")

          # è°ƒç”¨ Gemini CLIï¼Œè‡ªåŠ¨æ¥å—æ“ä½œ (-y)ï¼Œè¾“å‡ºçº¯æ–‡æœ¬ (-o text)
          OUTPUT=$(npx @google/gemini-cli "$PROMPT" -y -o text)

          # æ‰“å°åˆ°æ—¥å¿—
          echo "ğŸ“ Gemini says:"
          echo "$OUTPUT"

          # ä¿å­˜åˆ°è¾“å‡ºæ–‡ä»¶
          echo "$OUTPUT" > "${{ github.event.inputs.output_file }}"

          # è®¾ç½® workflow è¾“å‡ºå˜é‡
          echo "result<<EOF" >> $GITHUB_OUTPUT
          echo "$OUTPUT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      # 3ï¸âƒ£ å¯é€‰ï¼šå†æ¬¡å¼•ç”¨è¾“å‡º
      - name: Confirm output
        run: |
          echo "Captured output (first 200 chars):"
          echo "${{ steps.gemini.outputs.result }}" | head -c 200

      # 4ï¸âƒ£ ä¸Šä¼  Gemini è¾“å‡ºä½œä¸º Artifact
      - name: Upload Gemini output
        uses: actions/upload-artifact@v4
        with:
          name: gemini-output
          path: "${{ github.event.inputs.output_file }}"

